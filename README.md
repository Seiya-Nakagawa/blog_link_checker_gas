# ブログリンクチェッカー (Google Apps Script)

## 概要

このプロジェクトは、Google Apps Script（GAS）を使用して、ブログ内の外部リンクが有効かどうかを定期的にチェックするシステムです。

主な処理は以下の2つのスクリプトによって実行されます。

1.  **事前処理 (`pre_url_s3upload.gs`)**: スプレッドシートからチェック対象のURLリストを読み込み、AWS S3にアップロードします。
2.  **事後処理 (`post_result_s3download.gs`)**: AWS Lambdaでのリンクチェックが完了した後、S3から結果（CSV）をダウンロードし、スプレッドシートに反映します。また、前回の結果との差分を検出し、メールで通知します。

## 主な機能

- スプレッドシートでチェック対象のブログURLを管理
- AWS S3を介して、外部のリンクチェック処理（AWS Lambdaなど）と連携
- リンクチェック結果（成功、失敗、ステータスコードなど）をスプレッドシートに自動記録
- 前回のチェック結果と比較し、差分（追加、変更、削除）をハイライト表示
- 処理の完了や差分検出時に、指定したメールアドレスに自動で通知

## 設定方法

1.  **Google Apps Scriptプロジェクトの作成**: Google Drive上で新規にGASプロジェクトを作成し、各 `.gs` ファイルのコードをコピー＆ペーストします。
2.  **ライブラリの追加**: このスクリプトは `S3` ライブラリに依存しています。GASのエディタで以下のライブラリを追加してください。
    - **プロジェクトID**: `1W_s-A2cl2OQ5K-p26p_V_3-y3v32T22d1DEsP323G22d1DEsP323G`
    - **バージョン**: 最新のバージョンを選択
3.  **スクリプトプロパティの設定**: GASエディタの「プロジェクトの設定」 > 「スクリプト プロパティ」で、以下のキーと値を設定します。

| キー | 値の例 | 説明 |
| :--- | :--- | :--- |
| `SPREADSHEET_ID_WORK` | `12345abcde...` | 作業用スプレッドシートのID |
| `SPREADSHEET_ID_SOURCE` | `67890fghij...` | URLリストが記載された原本スプレッドシートのID |
| `S3_BUCKET_NAME` | `your-s3-bucket-name` | AWS S3バケット名 |
| `S3_BUCKET_REGION` | `ap-northeast-1` | S3バケットのリージョン |
| `EMAIL_ADDRESSES` | `your-email@example.com` | 通知を受け取るメールアドレス |
| `AWS_ACCESS_KEY_ID` | `AKIAIOSFODNN7EXAMPLE` | AWSアクセスキーID |
| `AWS_SECRET_ACCESS_KEY` | `wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY` | AWSシークレットアクセスキー |

4.  **トリガーの設定**: GASエディタの「トリガー」から、以下の関数を定期実行するように設定します。
    - `mainPreProcess`: 事前処理。リンクチェック処理の前に実行します。（例: 毎日午前1時）
    - `mainPostProcess`: 事後処理。リンクチェック処理の完了後に実行します。（例: 毎日午前3時）

## スプレッドシートの構成

### 原本スプレッドシート (`SPREADSHEET_ID_SOURCE`)

- **`ブログ一覧` シート**: チェック対象のURLを記載します。

### 作業用スプレッドシート (`SPREADSHEET_ID_WORK`)

- **`前回URLチェック件数` シート**: 前回のチェック対象URL件数を記録します。
- **`ブログ一覧` シート**: 原本からコピーされたURLリストです。
- **`ブログ一覧_手動` シート**: 手動で追加したいチェック対象URLを記載します。
- **`リンクチェック結果_当日` シート**: 最新のリンクチェック結果が反映されます。
- **`リンクチェック結果_前日` シート**: 前回のチェック結果がバックアップされます。

## 依存関係

- [GAS-S3](https://github.com/tanaikech/S3-for-Google-Apps-Script): Google Apps ScriptからAWS S3を操作するためのライブラリです。

## 注意事項

- AWSの認証情報（アクセスキー、シークレットキー）は、スクリプトプロパティに安全に保管してください。コード内に直接書き込まないでください。
- 本スクリプトは、AWS Lambdaなどで別途実装されたリンクチェック本体の処理と連携することを前提としています。